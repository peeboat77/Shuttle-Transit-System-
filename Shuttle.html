<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Soka Shuttle Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* PANEL BASE STYLES */
        .info-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 0 20px 20px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 10;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* DESKTOP STYLES (Floating Side Panel) */
        @media (min-width: 768px) {
            .info-panel {
                top: 20px;
                left: 20px;
                width: 340px;
                border-radius: 16px;
                padding-top: 20px;
            }
            .info-panel.collapsed {
                transform: translateX(calc(-100% - 40px));
            }
            .toggle-handle { display: none; }
            .desktop-toggle {
                position: absolute;
                top: 20px;
                left: 20px;
                z-index: 9;
                background: #003366;
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
        }

        /* MOBILE STYLES (Bottom Sheet) */
        @media (max-width: 767px) {
            .info-panel {
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 24px 24px 0 0;
            }
            .info-panel.collapsed {
                transform: translateY(calc(100% - 70px));
            }
            .toggle-handle {
                width: 100%;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            .handle-bar {
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            .desktop-toggle { display: none; }
        }

        /* CONTENT STYLING */
        .info-panel h2 {
            color: #003366;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 8px; height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .shuttle-info {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
        }
        .eta-time { font-size: 32px; font-weight: 700; }
        .eta-label { font-size: 13px; opacity: 0.8; }
        
        .stop-info {
            margin: 12px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .stop-info strong { color: #003366; font-size: 14px; }
        .stop-info p { color: #64748b; font-size: 13px; margin-top: 4px; }
        
        .btn {
            background: #003366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
        }
        .schedule { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
        .schedule-item { display: flex; justify-content: space-between; font-size: 13px; color: #64748b; padding: 4px 0; }
    </style>
</head>
<body>

<div id="map"></div>

<button class="desktop-toggle" onclick="togglePanel()">‚ò∞ View Schedule</button>

<div class="info-panel" id="ui-panel">
    <div class="toggle-handle" onclick="togglePanel()">
        <div class="handle-bar"></div>
    </div>
    
    <h2><span class="status-dot"></span> Shuttle Tracker</h2>
    
    <div class="shuttle-info">
        <h3>Next Arrival</h3>
        <div class="eta-time" id="eta-time">--</div>
        <div class="eta-label" id="eta-label">Calculating...</div>
    </div>
    
    <div class="stop-info">
        <strong id="stop-name">Ikeda Library</strong>
        <p id="stop-distance">Main Campus Hub</p>
    </div>
    
    <button class="btn" onclick="locateUser()">üìç Find My Location</button>
    
    <div class="schedule">
        <div class="schedule-item" id="next-shuttle">Next: --</div>
        <div class="schedule-item" id="following-shuttle">Following: --</div>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGVlYm9hdCIsImEiOiJjbWtyM3JnZm8wbDZsM2Rwemh2bXVwZnE5In0.ZneKju4nnhfYcJOg3TKRDA';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-117.7325, 33.5555],
        zoom: 14
    });

    // 1. THE ROAD-FOLLOWING ROUTE (NO BUILDINGS)
    const routeCoordinates = [
        [-117.7356, 33.5554], [-117.7348, 33.5575], [-117.7325, 33.5610], 
        [-117.7330, 33.5650], [-117.7315, 33.5710], [-117.7250, 33.5743], 
        [-117.7265, 33.5775], [-117.7241, 33.5784], [-117.7215, 33.5770], 
        [-117.7180, 33.5680], [-117.7145, 33.5665], [-117.7135, 33.5638], 
        [-117.7160, 33.5570], [-117.7220, 33.5535], [-117.7280, 33.5520], 
        [-117.7315, 33.5515], [-117.7340, 33.5535], [-117.7356, 33.5554]
    ];

    const stops = [
        { name: "Ikeda Library", coords: [-117.7356, 33.5554] },
        { name: "Town Center", coords: [-117.7250, 33.5743] },
        { name: "The Commons", coords: [-117.7241, 33.5784] },
        { name: "Walmart", coords: [-117.7135, 33.5638] }
    ];

    let shuttlePosition = 0;
    let shuttleMarker;

    // 2. TOGGLE LOGIC
    function togglePanel() {
        document.getElementById('ui-panel').classList.toggle('collapsed');
    }

    map.on('click', () => {
        if (window.innerWidth < 768) {
            document.getElementById('ui-panel').classList.add('collapsed');
        }
    });

    map.on('load', () => {
        map.addSource('route', {
            type: 'geojson',
            data: { type: 'Feature', geometry: { type: 'LineString', coordinates: routeCoordinates } }
        });
        
        map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#003366', 'line-width': 5, 'line-opacity': 0.8 }
        });

        stops.forEach(stop => {
            const el = document.createElement('div');
            el.style.width = '12px'; el.style.height = '12px';
            el.style.background = 'white'; el.style.border = '3px solid #003366';
            el.style.borderRadius = '50%';
            new mapboxgl.Marker(el).setLngLat(stop.coords).addTo(map);
        });

        const sEl = document.createElement('div');
        sEl.innerHTML = 'üöê'; sEl.style.fontSize = '32px';
        shuttleMarker = new mapboxgl.Marker(sEl).setLngLat(routeCoordinates[0]).addTo(map);

        animateShuttle();
        updateETAs();
    });

    function animateShuttle() {
        const speed = 1 / (30 * 60 * 60); 
        setInterval(() => {
            shuttlePosition = (shuttlePosition + speed) % 1;
            const totalSegments = routeCoordinates.length - 1;
            const segment = shuttlePosition * totalSegments;
            const idx = Math.floor(segment);
            const progress = segment - idx;
            const start = routeCoordinates[idx];
            const end = routeCoordinates[(idx + 1) % routeCoordinates.length];
            const lng = start[0] + (end[0] - start[0]) * progress;
            const lat = start[1] + (end[1] - start[1]) * progress;
            shuttleMarker.setLngLat([lng, lat]);
        }, 16);
    }

    function updateETAs() {
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        const next = Math.ceil(mins / 15) * 15;
        document.getElementById('eta-time').textContent = `${next - mins} min`;
        document.getElementById('eta-label').textContent = `Arriving at ${formatTime(next)}`;
        document.getElementById('next-shuttle').textContent = `Next: ${formatTime(next)}`;
        document.getElementById('following-shuttle').textContent = `Following: ${formatTime(next + 15)}`;
    }

    function formatTime(m) {
        const h = Math.floor(m / 60) % 24;
        const mins = m % 60;
        const dispH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `${dispH}:${mins.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
    }

    function locateUser() {
        navigator.geolocation.getCurrentPosition(p => {
            const { longitude, latitude } = p.coords;
            map.flyTo({ center: [longitude, latitude], zoom: 16 });
            new mapboxgl.Marker({color: '#3b82f6'}).setLngLat([longitude, latitude]).addTo(map);
        });
    }
</script>
</body>
</html>
