<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Soka Shuttle Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* PANEL BASE STYLES */
        .info-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 0 20px 20px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 20; /* Higher than toggle button */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* DESKTOP STYLES */
        @media (min-width: 768px) {
            .info-panel {
                top: 20px;
                left: 20px;
                width: 340px;
                border-radius: 16px;
                padding-top: 20px;
            }
            .info-panel.collapsed {
                transform: translateX(calc(-100% - 40px));
            }
            .toggle-handle { display: none; }
            .desktop-toggle {
                position: absolute;
                top: 20px;
                left: 20px;
                z-index: 10;
                background: #003366;
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
            .close-icon-desktop {
                display: block;
                cursor: pointer;
                font-size: 24px;
                color: #64748b;
                line-height: 1;
            }
        }

        /* MOBILE STYLES */
        @media (max-width: 767px) {
            .info-panel {
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 24px 24px 0 0;
            }
            .info-panel.collapsed {
                transform: translateY(calc(100% - 70px));
            }
            .toggle-handle {
                width: 100%;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            .handle-bar {
                width: 40px;
                height: 4px;
                background: #cbd5e1;
                border-radius: 2px;
            }
            .desktop-toggle { display: none; }
            .close-icon-desktop { display: none; }
        }

        /* CONTENT STYLING */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .info-panel h2 {
            color: #003366;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 8px; height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .shuttle-info {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
        }
        .eta-time { font-size: 32px; font-weight: 700; }
        .eta-label { font-size: 13px; opacity: 0.8; }
        
        .stop-info {
            margin: 12px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .stop-info strong { color: #003366; font-size: 14px; }
        .stop-info p { color: #64748b; font-size: 13px; margin-top: 4px; }
        
        .btn {
            background: #003366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
        }
        .schedule { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
        .schedule-item { display: flex; justify-content: space-between; font-size: 13px; color: #64748b; padding: 4px 0; }
    </style>
</head>
<body>

<div id="map"></div>

<button class="desktop-toggle" onclick="togglePanel()">üöê View Schedule</button>

<div class="info-panel" id="ui-panel">
    <div class="toggle-handle" onclick="togglePanel()">
        <div class="handle-bar"></div>
    </div>
    
    <div class="panel-header">
        <h2><span class="status-dot"></span> Shuttle Tracker</h2>
        <div class="close-icon-desktop" onclick="togglePanel()">&times;</div>
    </div>
    
    <div class="shuttle-info">
        <h3>Next Arrival</h3>
        <div class="eta-time" id="eta-time">--</div>
        <div class="eta-label" id="eta-label">Calculating...</div>
    </div>
    
    <div class="stop-info">
        <strong id="stop-name">Ikeda Library</strong>
        <p id="stop-distance">Main Campus Hub</p>
    </div>
    
    <button class="btn" onclick="locateUser()">üìç Find My Location</button>
    
    <div class="schedule">
        <div class="schedule-item" id="next-shuttle">Next: --</div>
        <div class="schedule-item" id="following-shuttle">Following: --</div>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGVlYm9hdCIsImEiOiJjbWtyM3JnZm8wbDZsM2Rwemh2bXVwZnE5In0.ZneKju4nnhfYcJOg3TKRDA';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-117.7325, 33.5555],
        zoom: 14.5
    });


    const stops = [
        { name: "Ikeda Library", coords: [-117.7356, 33.5554] },
        { name: "Town Center", coords: [-117.7250, 33.5743] },
        { name: "The Commons", coords: [-117.7241, 33.5784] },
        { name: "Walmart", coords: [-117.7135, 33.5638] },
        { name: "300 Residential Hall", coords: [-117.73548, 33.55343] },
        { name: "380 Residential Hall", coords: [-117.73642, 33.55383] },
        { name: "Ikeda Library", coords: [-117.7356, 33.5554] },
    ];

   

    function togglePanel() {
        document.getElementById('ui-panel').classList.toggle('collapsed');
    }

    // Map click hides panel only on mobile to keep desktop focus clean
    async function fetchRoadRoute() {
    const coords = stops.map(s => s.coords.join(',')).join(';');

    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&access_token=${mapboxgl.accessToken}`;

    const res = await fetch(url);
    const data = await res.json();

    return data.routes[0].geometry.coordinates;
}
    map.on('click', () => {
        if (window.innerWidth < 768) {
            document.getElementById('ui-panel').classList.add('collapsed');
        }
    });
    map.on('load', async () => {
    const snappedRoute = await fetchRoadRoute();

    map.addSource('route', {
        type: 'geojson',
        data: {
            type: 'Feature',
            geometry: {
                type: 'LineString',
                coordinates: snappedRoute
            }
        }
    });

    map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route',
        layout: {
            'line-join': 'round',
            'line-cap': 'round'
        },
        paint: {
            'line-color': '#003366',
            'line-width': 5,
            'line-opacity': 0.85
        }
    });

    // Store for animation
    window.routePath = snappedRoute;

    // Stops
    stops.forEach(stop => {
        const el = document.createElement('div');
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.background = 'red';
        el.style.border = '3px solid #003366';
        el.style.borderRadius = '50%';
        new mapboxgl.Marker(el).setLngLat(stop.coords).addTo(map);
    });

    const sEl = document.createElement('div');
    sEl.innerHTML = 'üöê';
    sEl.style.fontSize = '32px';

    shuttleMarker = new mapboxgl.Marker(sEl)
        .setLngLat(window.routePath[0])
        .addTo(map);

    animateShuttle();
    updateETAs();
    setInterval(updateETAs, 10000);
});
function animateShuttle() {
    let progress = 0;

    setInterval(() => {
        progress = (progress + 0.00002) % 1;

        const path = window.routePath;
        const total = path.length - 1;
        const idx = Math.floor(progress * total);
        const t = progress * total - idx;

        const start = path[idx];
        const end = path[idx + 1];

        const lng = start[0] + (end[0] - start[0]) * t;
        const lat = start[1] + (end[1] - start[1]) * t;

        shuttleMarker.setLngLat([lng, lat]);
    }, 16);
}

    function updateETAs() {
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        const next = Math.ceil(mins / 15) * 15;
        document.getElementById('eta-time').textContent = `${next - mins} min`;
        document.getElementById('eta-label').textContent = `Arriving at ${formatTime(next)}`;
        document.getElementById('next-shuttle').textContent = `Next: ${formatTime(next)}`;
        document.getElementById('following-shuttle').textContent = `Following: ${formatTime(next + 15)}`;
    }

    function formatTime(m) {
        const h = Math.floor(m / 60) % 24;
        const mins = m % 60;
        const dispH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `${dispH}:${mins.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
    }

    function locateUser() {
        navigator.geolocation.getCurrentPosition(p => {
            const { longitude, latitude } = p.coords;
            map.flyTo({ center: [longitude, latitude], zoom: 16 });
            new mapboxgl.Marker({color: '#3b82f6'}).setLngLat([longitude, latitude]).addTo(map);
        });
    }
</script>
</body>
</html>
